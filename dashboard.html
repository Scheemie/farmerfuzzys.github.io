<section id="sec-mods" class="content-section" style="display:none;">
    <h1>Mod-Datenbank</h1>
    
    <div id="modUploadBox" class="glass-card" style="display:none; border: 1px solid var(--accent); margin-bottom: 20px;">
        <h3>Neuen Mod hochladen</h3>
        <input id="modName" placeholder="Mod Name">
        <input id="modVersion" placeholder="Version">
        <input id="modType" placeholder="Art (z.B. Traktor)">
        <label>Datei (.zip):</label> <input type="file" id="modFile" accept=".zip">
        <label>Bild:</label> <input type="file" id="modImg" accept="image/*">
        <button id="uploadBtn" onclick="uploadMod()" class="btn-primary">Veröffentlichen</button>
    </div>

    <div id="modGallery" class="mod-grid"></div>
</section>

<script type="module">
    // ... (Firebase Imports wie vorher) ...
    import { deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // ... (Firebase Config & Init) ...

    let userRole = "user";

    onAuthStateChanged(auth, async user => {
        if (!user) { location.href = "index.html"; return; }
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) {
            const data = snap.data();
            userRole = data.role;
            document.getElementById('welcomeText').innerText = `Hallo, ${data.username}!`;
            
            // Rechte-Prüfung
            if (userRole === "admin") {
                document.getElementById('adminLinks').style.display = "block";
                document.getElementById('newRole').innerHTML += `<option value="modder">Modder</option>`; // Admin kann Modder erstellen
            }
            if (userRole === "admin" || userRole === "modder") {
                document.getElementById('modUploadBox').style.display = "block";
            }
        }
    });

    // MOD LÖSCHEN (Nur für Admins)
    window.deleteMod = async (modId, filePath, imgPath) => {
        if (userRole !== "admin") return alert("Nur Admins dürfen löschen!");
        if (!confirm("Willst du diesen Mod wirklich löschen?")) return;

        try {
            // 1. Dateien im Storage löschen (um Platz zu sparen)
            const fileRef = ref(storage, filePath);
            await deleteObject(fileRef);
            if(imgPath && !imgPath.includes("placeholder")) {
                await deleteObject(ref(storage, imgPath));
            }
            // 2. Eintrag in Firestore löschen
            await deleteDoc(doc(db, "mods", modId));
            alert("Mod gelöscht!");
            loadMods();
        } catch (e) { alert("Fehler beim Löschen: " + e.message); }
    };

    async function loadMods() {
        const snap = await getDocs(collection(db, "mods"));
        const gallery = document.getElementById('modGallery');
        gallery.innerHTML = "";
        snap.forEach(mDoc => {
            const m = mDoc.data();
            const isAdmin = userRole === "admin";
            gallery.innerHTML += `
                <div class="mod-card">
                    <img src="${m.imgUrl}">
                    <div class="mod-info">
                        <h4>${m.name}</h4>
                        <p>${m.type} | v${m.version}</p>
                        <a href="${m.fileUrl}" target="_blank" class="download-btn">Download</a>
                        ${isAdmin ? `<button onclick="deleteMod('${mDoc.id}', '${m.fullFilePath}', '${m.fullImgPath}')" class="btn-danger" style="width:100%; margin-top:5px;">Löschen</button>` : ''}
                    </div>
                </div>`;
        });
    }

    // Beim Upload müssen wir jetzt die Pfade mitspeichern, damit wir später löschen können
    window.uploadMod = async () => {
        // ... (Dateien holen wie vorher) ...
        const fullFilePath = `mods/${Date.now()}_${file.name}`;
        const fileRef = ref(storage, fullFilePath);
        // ... (Upload Logik) ...
        // Beim addDoc fügen wir 'fullFilePath' und 'fullImgPath' hinzu
    };
</script>
