<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | FarmerFuzzys</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden { display: none !important; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px; }
        .big-card { background: #0d1117; border: 1px solid #30363d; padding: 40px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .big-card:hover { border-color: #00f2ff; background: #161b22; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <img src="Farmerfuzzys_logo.jpg" class="nav-logo">
        <button class="nav-btn" onclick="location.reload()">Startseite</button>
        <button class="nav-btn" id="nav-admin" style="display:none;" onclick="showAdmin()">Verwaltung</button>
        <button class="nav-btn" onclick="logout()" style="margin-top:auto;">Abmelden</button>
    </nav>

    <main class="main-content">
        <h1 id="welcome-text">Prüfe Berechtigung...</h1>
        
        <div class="button-grid">
            <div id="card-dispo" class="big-card hidden" onclick="location.href='leitstelle.html'"><h3>Leitstelle</h3></div>
            <div id="card-ad" class="big-card hidden" onclick="location.href='alarm_display.html'"><h3>Alarm Display</h3></div>
            <div id="card-fz" class="big-card hidden" onclick="location.href='fahrzeug.html'"><h3>Fahrzeug-Modus</h3></div>
            <div id="card-admin" class="big-card hidden" onclick="showAdmin()"><h3>Verwaltung</h3></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDiYOJWP4XMQRJ6b-RfJp6Aqxis7E-uA30",
            authDomain: "farmerfuzzys-c32eb.firebaseapp.com",
            projectId: "farmerfuzzys-c32eb",
            storageBucket: "farmerfuzzys-c32eb.firebasestorage.app",
            messagingSenderId: "842395157432",
            appId: "1:842395157432:web:fd031d7cc0c2a6e69ec54d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            // WICHTIG: Pfad ist "users" + deine UID
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);

            if (snap.exists()) {
                const d = snap.data();
                const r = d.role || [];
                document.getElementById('welcome-text').innerText = "Willkommen zurück, " + (d.username || "Nutzer");

                if (r.includes("Admin")) {
                    document.getElementById('nav-admin').style.display = 'block';
                    document.getElementById('card-admin').classList.remove('hidden');
                }
                if (r.includes("Disponent")) document.getElementById('card-dispo').classList.remove('hidden');
                if (r.includes("AD")) document.getElementById('card-ad').classList.remove('hidden');
                if (r.includes("Einsatzfahrzeug")) document.getElementById('card-fz').classList.remove('hidden');
            } else {
                document.getElementById('welcome-text').innerText = "Fehler: Kein Datenbank-Profil gefunden!";
            }
        });

        window.logout = () => signOut(auth);
    </script>
</body>
</html>
